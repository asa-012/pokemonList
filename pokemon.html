<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Pokedex</title>
</head>
<body>

<!--loading-->

<div class="sk-chase1" id="loading_main">
    <div class="sk-chase-dot"></div>
    <div class="sk-chase-dot"></div>
    <div class="sk-chase-dot"></div>
    <div class="sk-chase-dot"></div>
    <div class="sk-chase-dot"></div>
    <div class="sk-chase-dot"></div>
</div>

<div id="scroll_area">
<h1>Pokedex</h1>
<div class="poke-container" id="poke-container"></div>
    <div class="sk-chase2" id="loading_again">
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
    </div>
</div>


<script>

    // 要素を取得する noneで非表示 blockで表示
    const poke_container = document.getElementById('poke-container')
    const mainLoading = document.getElementById('loading_main')
    const reLoading = document.getElementById('loading_again')

    // noneで非表示 blockで表示
    poke_container.style.display = "none"
    reLoading.style.display = "none"

    // 定数を定義
    // 表示するポケモン数
    let pokemon_count = 350;
    let pokemon_start_loading_count = 1;
    let pokemon_max_loading_count = 150;

    // カラー
    const colors = {
        fire: '#FDDFDF',
        grass: '#DEFDE0',
        electric: '#FCF7DE',
        water: '#DEF3FD',
        ground: '#f4e7da',
        rock: '#d5d5d4',
        fairy: '#fceaff',
        poison: '#98d7a5',
        bug: '#f8d5a3',
        dragon: '#97b3e6',
        psychic: '#eaeda1',
        flying: '#F5F5F5',
        fighting: '#E6E0D4',
        normal: '#F5F5F5'
    }

    // colorsのkeyを配列に格納
    const main_types = Object.keys(colors)

    // ポケモン取得
    const fetchPokemons = async () => {
        if(pokemon_count !== -1) {
            for (let i = pokemon_start_loading_count; i <= pokemon_max_loading_count; i++) {
                await getPokemon(i)
                if (i === pokemon_max_loading_count) {
                    mainLoading.remove()
                    poke_container.style.display = "block"
                }
            }
            //追加ローディング分岐処理
            if (pokemon_count <= pokemon_max_loading_count) {
                pokemon_count = -1
                pokemon_max_loading_count = -1
                //Nothing　追加ローディングなし
            } else if (pokemon_max_loading_count * 2 > pokemon_count) {
                //300の時に190だった場合に次の追加ローディングで190まで読み込みたいから
                pokemon_start_loading_count += pokemon_max_loading_count
                pokemon_max_loading_count = pokemon_count
            } else {
                //400とかだった場合に２倍の３００まで読み込む
                pokemon_start_loading_count += pokemon_max_loading_count
                pokemon_max_loading_count *= 2
            }
        }
    }

    const getPokemon = async (id) => {
        const url = `https://pokeapi.co/api/v2/pokemon/${id}`
        const res = await fetch(url)
        const data = await res.json()
        createPokemonCard(data)
    }

    // ポケモンカードを作成
    const createPokemonCard = (pokemon) => {
        // div要素を作成
        const pokemonEl = document.createElement('div')
        // pokemonクラスを追加
        pokemonEl.classList.add('pokemon')

        // ポケモン情報からデータを格納
        const name = pokemon.name[0].toUpperCase() + pokemon.name.slice(1)
        const id = pokemon.id.toString().padStart(3, '0')
        const poke_types = pokemon.types.map(type => type.type.name)
        const type = main_types.find(type => poke_types.indexOf(type) > -1)
        const image = pokemon.sprites['front_default']
        // ポケモンの背景色を設定
        pokemonEl.style.backgroundColor = colors[type]

        // ポケモンカードのテンプレ
        // ポケモンカードのテンプレートを追加
        pokemonEl.innerHTML = `
    <div class="img-container">
        <img src=${image} alt="">
    </div>
    <div class="info">
        <span class="number">#${id}</span>
        <h3 class="name">${name}</h3>
        <small class="type">Type: <span>${type}</span> </small>
    </div>
    `

        // poke_containerの子要素として追加
        poke_container.appendChild(pokemonEl)
    }

    function scrollToBottom(){
// 一番下までスクロールした時の数値を取得(window.innerHeight分(画面表示領域分)はスクロールをしないため引く)
        const bodyHeight = document.body.clientHeight // bodyの高さを取得
        const windowHeight = window.innerHeight // windowの高さを取得
        const bottomPoint = bodyHeight - windowHeight

        window.addEventListener('scroll', () => {
            const scrollTop = document.documentElement.scrollTop;
            console.log(scrollTop)

            // iosはバウンドするので、無難に `>=` にする
            if (scrollTop >= bottomPoint) {
                console.log("bottom")
                reLoading.style.display = "block"
                //TODO イベント発火したので動的にfetch処理を動かす処理を追加する
            }
        });
    }

    //非同期通信が終わってwindowはかりたいからthen
    fetchPokemons().then(() => {
        if(pokemon_count !== -1) {
            scrollToBottom()
        }
    })
    //Loading処理 https://tobiasahlin.com/spinkit/
    //
    // const script = document.createElement('script');
    // document.body.appendChild(script);

</script>
</body>
</html>


